# Page Truth Map - v0.4
# 
# SSOT for page-to-truth-source mappings.
# Gate: gate:ptm verifies all truth sources exist and are loadable.
# 
# This file answers: "Which sources determine the semantic content of each page?"

version: "0.4"
created_at: "2026-01-18T00:00:00Z"
description: |
  v0.4 Page Truth Map defines the mapping between Validation Lab pages
  and their authoritative truth sources. Any third party can verify:
  1. Truth sources exist and are loadable
  2. Page semantics match declared sources
  3. No version drift between page and data

# ============================================================================
# Route Mappings
# ============================================================================

routes:
  # ---------------------------------------------------------------------------
  # /runs - Runs List Page
  # ---------------------------------------------------------------------------
  - route: "/runs"
    version_scope: "v0.4"
    description: "Curated runs index showing v0.2/v0.3/v0.4 packs in three sections"
    requires_ui_semantics: true
    
    truth_sources:
      allowlist: "data/curated-runs/allowlist.yaml"
      rulesets:
        - "ruleset-1.0"
        - "ruleset-1.1"
        - "ruleset-1.2"
      generated_data: "public/_data/curated-runs.json"
    
    assertions:
      # v0.4 Section
      - type: "dom_exists"
        selector: "h2"
        text_contains: "Semantic Invariant Packs"
      - type: "text_visible"
        text: "ruleset-1.2"
      # v0.3 Section
      - type: "dom_exists"
        selector: "h2"
        text_contains: "Four-Domain Packs"
      - type: "text_visible"
        text: "ruleset-1.1"
      # v0.2 Section
      - type: "dom_exists"
        selector: "h2"
        text_contains: "GoldenFlow Packs"
      - type: "text_visible"
        text: "ruleset-1.0"
      # Count
      - type: "run_count"
        min: 26

  # ---------------------------------------------------------------------------
  # /runs/[run_id] - Run Detail Page (PASS sample)
  # ---------------------------------------------------------------------------
  - route: "/runs/arb-d1-budget-pass-fixture-v0.3"
    version_scope: "v0.4"
    description: "Run detail page showing PASS verdict with domain metadata"
    requires_ui_semantics: true
    
    truth_sources:
      run_bundle: "data/runs/arb-d1-budget-pass-fixture-v0.3"
      ruleset: "ruleset-1.1"
    
    assertions:
      - type: "dom_exists"
        selector: "[data-testid='verdict-badge']"
        text_contains: "PASS"
      - type: "dom_exists"
        selector: ".domain-meta"
      - type: "text_visible"
        text: "D1"

  # ---------------------------------------------------------------------------
  # /runs/[run_id] - Run Detail Page (v0.4 FAIL sample)
  # ---------------------------------------------------------------------------
  - route: "/runs/arb-d1-budget-fail-outcome-invalid-v0.4"
    version_scope: "v0.4"
    description: "Run detail page showing v0.4 FAIL with semantic invariant reason"
    requires_ui_semantics: true
    
    truth_sources:
      run_bundle: "data/runs/arb-d1-budget-fail-outcome-invalid-v0.4"
      ruleset: "ruleset-1.2"
    
    assertions:
      - type: "dom_exists"
        selector: "[data-testid='verdict-badge']"
        text_contains: "FAIL"
      - type: "text_visible"
        text: "D1_OUTCOME_INVALID"
      - type: "dom_exists"
        selector: ".reason-code"

# ============================================================================
# Sample Run IDs for UI Semantic Tests (PTM-driven)
# ============================================================================

ui_test_samples:
  v03_pass: "arb-d1-budget-pass-fixture-v0.3"
  v03_fail: "arb-d1-budget-fail-fixture-v0.3"
  v04_pass: "arb-d1-budget-pass-fixture-v0.3"  # v0.3 PASS still valid under v0.4
  v04_fail: "arb-d1-budget-fail-outcome-invalid-v0.4"

# ============================================================================
# Ruleset Registry (must be loadable)
# ============================================================================

rulesets_required:
  - id: "ruleset-1.0"
    manifest: "data/rulesets/ruleset-1.0/manifest.yaml"
    adjudicator: "lib/rulesets/ruleset-1.0/adjudicate.ts"
  - id: "ruleset-1.1"
    manifest: "data/rulesets/ruleset-1.1/manifest.yaml"
    adjudicator: "lib/rulesets/ruleset-1.1/adjudicate.ts"
  - id: "ruleset-1.2"
    manifest: "data/rulesets/ruleset-1.2/manifest.yaml"
    adjudicator: "lib/rulesets/ruleset-1.2/adjudicate.ts"
