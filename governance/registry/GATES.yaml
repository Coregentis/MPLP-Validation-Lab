# Gates Registry - v0.7.2
#
# SSOT for all CI gates and their relationship to routes and truth sources.
# v0.7.2 Integration: P0 Projection Gates (projection-map, no-ssot-duplication, cross-repo)
#
# Governance: REPO_SHAPE.md / VLAB-DGB-01

version: "0.7.2"
schema_version: "1.0.0"
description: |
  Registry of all CI gates with their entrypoints, verification targets,
  applicable routes, and truth source dependencies.
  
  Gate ID naming convention:
  - scripts/gates/*.mjs: gate:{name} (e.g., gate:registry, gate:ptm)
  - lib/gates/*.ts: gate:{number} (e.g., gate:04, gate:05) - to be renamed to lib/runtime-checks

# =============================================================================
# Gate Definitions
# =============================================================================

gates:
  # ---------------------------------------------------------------------------
  # Terminology & Language Gates
  # ---------------------------------------------------------------------------
  - gate_id: "gate:terminology"
    entrypoint: "scripts/gates/terminology-gate.mjs"
    npm_script: null  # run directly with node
    verifies:
      - "LG-xx displayed in external UI (not GF-xx)"
      - "No 'Golden Flow' in external display"
    applies_to_routes:
      - "/runs"
      - "/runs/*"
      - "/guarantees"
    depends_on:
      - "ts.terminology"
    failure_impact: "Terminology collision with main repo"

  - gate_id: "gate:04"
    entrypoint: "lib/gates/gate-04-language.ts"
    npm_script: "gate:04"
    verifies:
      - "Non-endorsement language compliance"
    applies_to_routes:
      - "/*"
    depends_on: []
    failure_impact: "Endorsement boundary violation"

  - gate_id: "gate:05"
    entrypoint: "lib/gates/gate-05-no-exec-hosting.ts"
    npm_script: "gate:05"
    verifies:
      - "No execution hosting claims"
    applies_to_routes:
      - "/*"
    depends_on: []
    failure_impact: "Execution hosting boundary violation"

  # ---------------------------------------------------------------------------
  # Policy Gates
  # ---------------------------------------------------------------------------
  - gate_id: "gate:06"
    entrypoint: "lib/gates/gate-06-robots-policy.ts"
    npm_script: "gate:06"
    verifies:
      - "Run detail pages have noindex by default"
    applies_to_routes:
      - "/runs/*"
    depends_on: []
    failure_impact: "SEO policy violation"

  - gate_id: "gate:07"
    entrypoint: "lib/gates/gate-07-pii-leak.ts"
    npm_script: "gate:07"
    verifies:
      - "No PII leaks in evidence"
    applies_to_routes:
      - "/runs/*"
    depends_on:
      - "ts.run_bundles"
    failure_impact: "Privacy violation"

  # ---------------------------------------------------------------------------
  # Curated Runs Gates
  # ---------------------------------------------------------------------------
  - gate_id: "gate:08"
    entrypoint: "lib/gates/gate-08-curated-immutability.ts"
    npm_script: "gate:08"
    verifies:
      - "Curated runs are immutable"
    applies_to_routes:
      - "/runs"
    depends_on:
      - "ts.curated_allowlist"
      - "ts.run_bundles"
    failure_impact: "Evidence reproducibility broken"

  - gate_id: "gate:curated-runs"
    entrypoint: "scripts/gates/curated-runs-closure.mjs"
    npm_script: "gate:curated-runs"
    verifies:
      - "All curated runs are adjudicable"
      - "No missing reason codes"
    applies_to_routes:
      - "/runs"
      - "/runs/*"
    depends_on:
      - "ts.curated_allowlist"
      - "ts.registry"
    failure_impact: "Run evaluation broken"

  - gate_id: "gate:ssot-consistency"
    entrypoint: "scripts/gates/ssot-consistency.mjs"
    npm_script: "gate:ssot-consistency"
    verifies:
      - "SSOT Consistency across substrate-index, curated-runs, and runsets"
      - "All substrates in index have corresponding runs (warn by default, fail in strict)"
    applies_to_routes:
      - "/runs"
      - "/runs/*"
    depends_on:
      - "ts.runsets"
      - "ts.export_curated_json"
      - "ts.substrate_index"

  - gate_id: "gate:coverage-claim"
    entrypoint: "scripts/gates/coverage-claim.mjs"
    npm_script: "gate:coverage-claim"
    verifies:
      - "No Claim Without Artifact (matrix, index, export)"
      - "E-S claims must have signed_proof_ref (enforced)"
    applies_to_routes:
      - "/coverage"
      - "/runs/*"
    depends_on:
      - "ts.export_curated_json"
      - "ts.substrate_index"
      - "ts.coverage_matrix"
    failure_impact: "Audit boundary violation"

  - gate_id: "gate:09"
    entrypoint: "lib/gates/gate-09-ssot-projection.ts"
    npm_script: "gate:09"
    verifies:
      - "UI projection matches SSOT"
    applies_to_routes:
      - "/runs"
    depends_on:
      - "ts.export_curated_json"
      - "ts.ui_curated_json"
    failure_impact: "UI/data drift"

  - gate_id: "gate:10"
    entrypoint: "lib/gates/gate-10-curated-invariants.ts"
    npm_script: "gate:10"
    verifies:
      - "Curated runs meet invariants"
    applies_to_routes:
      - "/runs/*"
    depends_on:
      - "ts.run_bundles"
    failure_impact: "Invariant violation"

  # ---------------------------------------------------------------------------
  # Registry & Ruleset Gates
  # ---------------------------------------------------------------------------
  - gate_id: "gate:registry"
    entrypoint: "scripts/gates/registry-contract.mjs"
    npm_script: "gate:registry"
    verifies:
      - "All rulesets loadable from registry"
      - "Each ruleset has adjudicator"
    applies_to_routes:
      - "/rulesets"
      - "/rulesets/*"
    depends_on:
      - "ts.registry"
      - "ts.ruleset_manifests"
    failure_impact: "Ruleset loading broken"

  - gate_id: "gate:reason-codes"
    entrypoint: "scripts/gates/reason-codes.mjs"
    npm_script: "gate:reason-codes"
    verifies:
      - "All reason codes are in taxonomy"
    applies_to_routes:
      - "/runs/*"
    depends_on:
      - "ts.run_bundles"
    failure_impact: "Unknown reason codes in verdicts"

  # ---------------------------------------------------------------------------
  # Shadow Parity & Consistency Gates
  # ---------------------------------------------------------------------------
  - gate_id: "gate:shadow-parity"
    entrypoint: "scripts/gates/shadow-parity.mjs"
    npm_script: "gate:shadow-parity"
    verifies:
      - "Lab verdict = local recompute verdict"
    applies_to_routes:
      - "/runs/*"
    depends_on:
      - "ts.runsets"
      - "ts.registry"
    failure_impact: "Third-party reproducibility broken"

  - gate_id: "gate:runset-consistency"
    entrypoint: "scripts/gates/runset-consistency.mjs"
    npm_script: "gate:runset-consistency"
    verifies:
      - "Curated and cross-substrate sets are disjoint"
    applies_to_routes:
      - "/runs"
    depends_on:
      - "ts.runsets"
    failure_impact: "Runset integrity violation"

  # ---------------------------------------------------------------------------
  # v0.5 Signing & Key Gates
  # ---------------------------------------------------------------------------
  - gate_id: "gate:proof-signature"
    entrypoint: "scripts/gates/proof-signature.mjs"
    npm_script: "gate:proof-signature"
    verifies:
      - "All proofs are signed and verifiable"
    applies_to_routes:
      - "/runs/*"
    depends_on:
      - "ts.identity"
      - "ts.run_bundles"
    failure_impact: "Signature chain broken"

  - gate_id: "gate:key-policy"
    entrypoint: "scripts/gates/key-policy.mjs"
    npm_script: "gate:key-policy"
    verifies:
      - "Signing keys comply with key policy"
      - "No revoked keys accepted"
    applies_to_routes:
      - "/"
      - "/about"
    depends_on:
      - "ts.identity"
    failure_impact: "Key governance violation"

  - gate_id: "gate:secret-hygiene"
    entrypoint: "scripts/gates/secret-hygiene.mjs"
    npm_script: "gate:secret-hygiene"
    verifies:
      - "No private keys in repository"
    applies_to_routes: []
    depends_on: []
    failure_impact: "Secret leak"

  # ---------------------------------------------------------------------------
  # v0.5 Cross-Substrate Gates
  # ---------------------------------------------------------------------------
  - gate_id: "gate:cross-substrate"
    entrypoint: "scripts/gates/cross-substrate-repro.mjs"
    npm_script: "gate:cross-substrate"
    verifies:
      - "Cross-platform reproduction parity"
      - "Clause vector parity across substrates"
    applies_to_routes:
      - "/examples/evidence-producers/*"
    depends_on:
      - "ts.producer_manifests"
      - "ts.producer_packs"
    failure_impact: "Cross-substrate reproducibility broken"

  - gate_id: "gate:test-vectors-coverage"
    entrypoint: "scripts/gates/test-vectors-coverage.mjs"
    npm_script: "gate:test-vectors-coverage"
    verifies:
      - "Test vector coverage per domain"
    applies_to_routes:
      - "/coverage"
    depends_on:
      - "ts.test_vectors_allowlist"
      - "ts.test_vectors"
    failure_impact: "Test coverage gap"

  - gate_id: "gate:canonptr-coverage"
    entrypoint: "scripts/gates/canonptr-coverage.mjs"
    npm_script: "gate:canonptr-coverage"
    verifies:
      - "CanonPtr v1 coverage in cross-substrate packs"
    applies_to_routes:
      - "/examples/evidence-producers/*"
    depends_on:
      - "ts.producer_packs"
    failure_impact: "CanonPtr not universal"

  - gate_id: "gate:portable-hash-parity"
    entrypoint: "scripts/gates/portable-hash-parity.mjs"
    npm_script: "gate:portable-hash-parity"
    verifies:
      - "Portable verdict hash parity across substrates"
    applies_to_routes:
      - "/examples/evidence-producers/*"
    depends_on:
      - "ts.producer_packs"
    failure_impact: "Hash parity broken"

  # ---------------------------------------------------------------------------
  # PTM Gate
  # ---------------------------------------------------------------------------
  - gate_id: "gate:ptm"
    entrypoint: "scripts/gates/page-truth-map.mjs"
    npm_script: "gate:ptm"
    verifies:
      - "Page Truth Map coverage = 18/18"
      - "Each route has truth source"
      - "Each route has gate or exemption"
    applies_to_routes:
      - "/*"
    depends_on:
      - "ts.registry.routes"
      - "ts.registry.truth_sources"
      - "ts.registry.gates"
      - "ts.ptm"
    failure_impact: "PTM coverage gap"

  # ---------------------------------------------------------------------------
  # Upstream Sync Gates
  # ---------------------------------------------------------------------------
  - gate_id: "gate:vlab:00"
    entrypoint: "scripts/gates/verify-upstream-pin.ts"
    npm_script: "gate:vlab:00"
    verifies:
      - "Upstream pin is valid"
    applies_to_routes: []
    depends_on: []
    failure_impact: "Upstream sync broken"

  - gate_id: "gate:vlab:01"
    entrypoint: "scripts/gates/verify-schema-alignment.ts"
    npm_script: "gate:vlab:01"
    verifies:
      - "Schemas aligned with upstream"
    applies_to_routes: []
    depends_on: []
    failure_impact: "Schema drift"

  # ---------------------------------------------------------------------------
  # v0.7 Elevation Gates
  # ---------------------------------------------------------------------------
  - gate_id: "gate:projection-manifest"
    entrypoint: "scripts/gates/projection-manifest.mjs"
    npm_script: "gate:projection-manifest"
    verifies:
      - "Release manifest hashes match repository state"
      - "Provable baseline integrity"
    applies_to_routes:
      - "/*"
    depends_on:
      - "ts.projection_manifest"
      - "ts.registry.gates"
      - "ts.registry.routes"
      - "ts.registry.truth_sources"
    failure_impact: "Provable baseline corruption"

  - gate_id: "gate:projection-sanity"
    entrypoint: "scripts/gates/projection-sanity.mjs"
    npm_script: "gate:projection-sanity"
    verifies:
      - "UI counts match SSOT export counts"
      - "Substrate index consistency"
    applies_to_routes:
      - "/runs"
      - "/coverage"
      - "/rulesets"
    depends_on:
      - "ts.export_curated_json"
      - "ts.ui_curated_json"
    failure_impact: "UI/SSOT data mismatch"

  # ---------------------------------------------------------------------------
  # P0 Projection Governance Gates (v0.7.2)
  # ---------------------------------------------------------------------------
  - gate_id: "gate:projection-map"
    entrypoint: "scripts/gates/projection-map.mjs"
    npm_script: "gate:projection-map"
    verifies:
      - "All registered routes mapped in projection-map.json"
      - "All artifacts have required fields"
      - "Forbidden projection categories defined"
    applies_to_routes:
      - "/*"  # All routes must be accounted for
    depends_on:
      - "ts.projection_map"
      - "ts.registry.routes"
    failure_impact: "Projection governance structure invalid"

  - gate_id: "gate:no-ssot-duplication"
    entrypoint: "scripts/gates/no-ssot-duplication.mjs"
    npm_script: "gate:no-ssot-duplication"
    verifies:
      - "Website: no substrate enumeration, coverage numbers, verdict status"
      - "Docs: no verdict status, coverage matrices, ruleset requirements"
      - "Cross-repo: allowlists for governance files"
    applies_to_routes:
      - "/*"  # Protects entire projection surface
    depends_on:
      - "ts.projection_map"
      - "external:website"  # ../MPLP_website
      - "external:docs"     # ../docs
    failure_impact: "SSOT duplication detected across surfaces"

  - gate_id: "gate:website-pointer-only"
    entrypoint: "../MPLP_website/scripts/gates/website-pointer-only.mjs"
    npm_script: "gate:website-pointer-only"
    repository: "MPLP_website"
    verifies:
      - "No forbidden terms (Certified, Ranked, Endorsed, Compliant)"
      - "No data mirroring (substrate counts, coverage %)"
      - "Lab link integrity"
    applies_to_routes:
      - "external:website/*"
    depends_on:
      - "ts.projection_map"
    failure_impact: "Website pointer-only boundary violation"

  - gate_id: "gate:docs-nonnormative-pointer-only"
    entrypoint: "../docs/scripts/gates/docs-nonnormative-pointer-only.mjs"
    npm_script: "gate:docs-nonnormative-pointer-only"
    repository: "docs"
    verifies:
      - "Non-normative disclaimer present in Lab docs"
      - "No data mirroring (PASSED/FAILED counts, coverage %)"
      - "Lab link required"
    applies_to_routes:
      - "external:docs/validation-lab/*"
    depends_on:
      - "ts.projection_map"
    failure_impact: "Docs non-normative boundary violation"

  - gate_id: "gate:post-task-association"
    entrypoint: "scripts/gates/post-task-association.mjs"
    npm_script: "gate:post-task-association"
    verifies:
      - "PR includes Task Completion Report in governance/reports/task-completion/"
      - "SOP-VLAB-PROJ-SYNC-01 compliance"
    applies_to_routes:
      - "/*"  # Applies to all PR changes
    depends_on:
      - "ts.sop_proj_sync_01"
      - "ts.task_completion_template"
    failure_impact: "PR missing mandatory Task Completion Report (SOP violation)"

# =============================================================================
# Exemptions (routes with no gate, must have explicit reason)
# =============================================================================

exemptions:
  - route: "/builder"
    reason: "Development tool, no production data dependency"
    
  - route: "/adjudication"
    reason: "Entry page only, detail pages covered by /runs/* gates"

# =============================================================================
# Summary
# =============================================================================

summary:
  total_gates: 30  # +1 post-task-association
  by_location:
    scripts_gates: 21  # +1
    lib_gates: 9
  by_scope:
    lab_internal: 25
    cross_repo: 4
    sop_enforcement: 1  # post-task-association
  covered_routes: 18
  exempted_routes: 2
