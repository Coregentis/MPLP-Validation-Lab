name: Quality Gates

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

jobs:
  quality-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Type Check
        run: npx tsc --noEmit

      - name: Build
        run: npm run build

      - name: Terminology Gate
        run: node scripts/gates/terminology-gate.mjs

      # v0.4 Gates
      - name: Generate Curated Runs Data
        run: npm run generate:curated

      - name: Registry Contract Gate
        run: npm run gate:registry

      - name: Curated Runs Closure Gate
        run: npm run gate:curated-runs

      - name: Reason Codes Taxonomy Gate
        run: npm run gate:reason-codes

      - name: Page Truth Map Gate
        run: npm run gate:ptm

      - name: Shadow Parity Gate (生死线)
        run: npm run gate:shadow-parity

      # v0.5 Gates
      - name: Proof Signature Gate
        run: npm run gate:proof-signature
        env:
          VLAB_SIGNING_KEY_ED25519_PROD: ${{ secrets.VLAB_SIGNING_KEY_ED25519_PROD }}

      - name: Test Vectors Coverage Gate
        run: npm run gate:test-vectors-coverage

      - name: Cross-Substrate Reproduction Gate
        run: npm run gate:cross-substrate

      - name: RunSet Consistency Gate
        run: npm run gate:runset-consistency

      - name: Key Policy Gate
        run: npm run gate:key-policy

      - name: CanonPtr Coverage Gate
        run: npm run gate:canonptr-coverage

      - name: Portable Hash Parity Gate
        run: npm run gate:portable-hash-parity

      - name: Secret Hygiene Gate
        run: npm run gate:secret-hygiene

      # Website & Governance Gates (v0.5)
      - name: Link Integrity Gate (R4)
        run: node scripts/ci/link-integrity-gate.mjs

      - name: Top-level Directory Whitelist Gate (G-TOP-01)
        run: node scripts/ci/toplevel-whitelist-gate.mjs

      - name: Release Index Integrity Gate (G-REL-01)
        run: node scripts/ci/release-index-gate.mjs

      - name: Substrate SSOT Consistency Gate (G-SSOT-SUBSTRATE-01)
        run: node scripts/ci/substrate-ssot-gate.mjs

      - name: Guarantees SSOT Consistency Gate (G-GUARANTEES-SSOT-01)
        run: node scripts/ci/guarantees-ssot-gate.mjs

      # P0 Projection Gates (v0.7.2)
      - name: Projection Map Gate (P0-2)
        run: npm run gate:projection-map

      - name: No-SSOT-Duplication Gate (P0-3)
        run: npm run gate:no-ssot-duplication

      # SOP Enforcement (enabled after bootstrap)
      - name: Post-Task Association Gate (SOP)
        run: npm run gate:post-task-association

      # V1/V2/Unified Gates (Lint Zero & Audit)
      - name: Unified & V2 Gates (gate:all)
        run: npm run gate:all
